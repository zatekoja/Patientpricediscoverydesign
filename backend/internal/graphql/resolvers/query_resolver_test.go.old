package resolvers

import (
	"context"
	"testing"
	"time"

	"github.com/stretchr/testify/assert"
	"github.com/zatekoja/Patientpricediscoverydesign/backend/internal/domain/entities"
	"github.com/zatekoja/Patientpricediscoverydesign/backend/internal/domain/repositories"
	"github.com/zatekoja/Patientpricediscoverydesign/backend/internal/graphql/generated"
	"github.com/zatekoja/Patientpricediscoverydesign/backend/tests/mocks"
)

// TestQueryResolver_Facility_Success tests successful facility retrieval
func TestQueryResolver_Facility_Success(t *testing.T) {
	// Arrange
	mockSearch := mocks.NewMockSearchAdapter(t)
	mockDB := mocks.NewMockFacilityRepository(t)
	mockCache := mocks.NewMockQueryCacheProvider(t)

	resolver := NewResolver(mockSearch, mockDB, mockCache)
	queryResolver := resolver.Query()

	ctx := context.Background()
	facilityID := "fac-123"

	expectedFacility := &entities.Facility{
		ID:           facilityID,
		Name:         "Test Hospital",
		FacilityType: "hospital",
		Location: entities.Location{
			Latitude:  37.7749,
			Longitude: -122.4194,
		},
		Rating:      4.5,
		ReviewCount: 100,
		IsActive:    true,
		CreatedAt:   time.Now(),
	}

	// Cache miss, DB hit
	mockCache.EXPECT().Get(ctx, "facility:"+facilityID).Return(nil, assert.AnError)
	mockDB.EXPECT().GetByID(ctx, facilityID).Return(expectedFacility, nil)
	mockCache.EXPECT().Set(ctx, "facility:"+facilityID, expectedFacility, 5*time.Minute).Return(nil)

	// Act
	result, err := queryResolver.Facility(ctx, facilityID)

	// Assert
	assert.NoError(t, err)
	assert.NotNil(t, result)
	assert.Equal(t, facilityID, result.ID)
	assert.Equal(t, "Test Hospital", result.Name)
}

// TestQueryResolver_Facility_NotFound tests facility not found
func TestQueryResolver_Facility_NotFound(t *testing.T) {
	// Arrange
	mockSearch := mocks.NewMockSearchAdapter(t)
	mockDB := mocks.NewMockFacilityRepository(t)
	mockCache := mocks.NewMockQueryCacheProvider(t)

	resolver := NewResolver(mockSearch, mockDB, mockCache)
	queryResolver := resolver.Query()

	ctx := context.Background()
	facilityID := "non-existent"

	// Cache miss, DB miss
	mockCache.EXPECT().Get(ctx, "facility:"+facilityID).Return(nil, assert.AnError)
	mockDB.EXPECT().GetByID(ctx, facilityID).Return(nil, assert.AnError)

	// Act
	result, err := queryResolver.Facility(ctx, facilityID)

	// Assert
	assert.Error(t, err)
	assert.Nil(t, result)
}

// TestQueryResolver_SearchFacilities_Success tests successful facility search
func TestQueryResolver_SearchFacilities_Success(t *testing.T) {
	// Arrange
	mockSearch := mocks.NewMockSearchAdapter(t)
	mockDB := mocks.NewMockFacilityRepository(t)
	mockCache := mocks.NewMockQueryCacheProvider(t)

	resolver := NewResolver(mockSearch, mockDB, mockCache)
	queryResolver := resolver.Query()

	ctx := context.Background()
	query := "hospital"
	location := generated.LocationInput{
		Latitude:  37.7749,
		Longitude: -122.4194,
	}
	radiusKm := 10.0

	expectedFacilities := []*entities.Facility{
		{
			ID:           "fac-1",
			Name:         "Test Hospital",
			FacilityType: "hospital",
			Location: entities.Location{
				Latitude:  37.7749,
				Longitude: -122.4194,
			},
			Rating:      4.5,
			ReviewCount: 100,
			IsActive:    true,
		},
	}

	mockSearch.EXPECT().Search(ctx, repositories.SearchParams{
		Query:     query,
		Latitude:  location.Latitude,
		Longitude: location.Longitude,
		RadiusKm:  radiusKm,
		Limit:     20,
		Offset:    0,
	}).Return(expectedFacilities, nil)

	// Act
	result, err := queryResolver.SearchFacilities(ctx, query, location, &radiusKm, nil)

	// Assert
	assert.NoError(t, err)
	assert.NotNil(t, result)
	assert.Len(t, result.Facilities, 1)
	assert.Equal(t, "fac-1", result.Facilities[0].ID)
}

// TestQueryResolver_Facilities_Success tests facilities search with filter
func TestQueryResolver_Facilities_Success(t *testing.T) {
	// Arrange
	mockSearch := mocks.NewMockSearchAdapter(t)
	mockDB := mocks.NewMockFacilityRepository(t)
	mockCache := mocks.NewMockQueryCacheProvider(t)

	resolver := NewResolver(mockSearch, mockDB, mockCache)
	queryResolver := resolver.Query()

	ctx := context.Background()
	filter := generated.FacilitySearchInput{
		Location: &generated.LocationInput{
			Latitude:  37.7749,
			Longitude: -122.4194,
		},
		RadiusKm: 10.0,
		Limit:    ptr(20),
		Offset:   ptr(0),
	}

	expectedFacilities := []*entities.Facility{
		{
			ID:           "fac-1",
			Name:         "Test Hospital",
			FacilityType: "hospital",
			IsActive:     true,
		},
	}

	mockSearch.EXPECT().Search(ctx, repositories.SearchParams{
		Latitude:  filter.Location.Latitude,
		Longitude: filter.Location.Longitude,
		RadiusKm:  filter.RadiusKm,
		Limit:     20,
		Offset:    0,
	}).Return(expectedFacilities, nil)

	// Act
	result, err := queryResolver.Facilities(ctx, filter)

	// Assert
	assert.NoError(t, err)
	assert.NotNil(t, result)
	assert.Len(t, result.Facilities, 1)
	assert.Equal(t, 1, result.TotalCount)
}

// Helper function
func ptr(v int) *int {
	return &v
}
