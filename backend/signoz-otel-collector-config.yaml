receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318
        cors:
          allowed_origins:
            - "*"

  # Scrape metrics from database exporters
  prometheus:
    config:
      scrape_configs:
        - job_name: 'postgres-exporter'
          scrape_interval: 30s
          static_configs:
            - targets: ['postgres-exporter:9187']
              labels:
                service: 'postgres'
                component: 'database'

        - job_name: 'redis-exporter'
          scrape_interval: 30s
          static_configs:
            - targets: ['redis-exporter:9121']
              labels:
                service: 'redis'
                component: 'cache'

        - job_name: 'mongodb-exporter'
          scrape_interval: 30s
          static_configs:
            - targets: ['mongodb-exporter:9216']
              labels:
                service: 'mongodb'
                component: 'database'

processors:
  batch:
    timeout: 1s
    send_batch_size: 1024

  # Add resource attributes for better filtering
  resource:
    attributes:
      - key: service.namespace
        value: patient-price-discovery
        action: upsert

exporters:
  clickhousetraces:
    datasource: tcp://clickhouse:9000/?database=signoz_traces&username=admin&password=admin
    low_cardinal_exception_grouping: false
  
  clickhousemetricswrite:
    endpoint: tcp://clickhouse:9000/?database=signoz_metrics&username=admin&password=admin
    resource_to_telemetry_conversion:
      enabled: true

  # Use clickhouselogsexporter for log export
  clickhouselogsexporter:
    dsn: tcp://clickhouse:9000/?database=signoz_logs&username=admin&password=admin
    timeout: 5s
    retry_on_failure:
      enabled: true
      initial_interval: 5s
      max_interval: 30s
      max_elapsed_time: 300s

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [batch, resource]
      exporters: [clickhousetraces]

    metrics:
      receivers: [otlp, prometheus]
      processors: [batch, resource]
      exporters: [clickhousemetricswrite]

    logs:
      receivers: [otlp]
      processors: [batch, resource]
      exporters: [clickhouselogsexporter]