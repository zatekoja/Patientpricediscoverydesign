version: '3.8'

# Docker Compose for Integration Testing
# This sets up a lightweight test environment

services:
  postgres-test:
    image: postgres:15-alpine
    container_name: ppd_postgres_test
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: patient_price_discovery_test
    ports:
      - "5440:5432"  # Use different port to avoid conflict with dev db
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    tmpfs:
      - /var/lib/postgresql/data  # Use tmpfs for faster tests

  typesense-test:
    image: typesense/typesense:27.1
    container_name: ppd_typesense_test
    environment:
      TYPESENSE_DATA_DIR: /data
      TYPESENSE_API_KEY: xyz
      TYPESENSE_ENABLE_CORS: true
    ports:
      - "8109:8108"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8108/health"]
      interval: 5s
      timeout: 5s
      retries: 5
    tmpfs:
      - /data

  clickhouse-test:
    image: clickhouse/clickhouse-server:23.11-alpine
    container_name: ppd_clickhouse_test
    environment:
      CLICKHOUSE_DB: signoz_metrics
      CLICKHOUSE_USER: admin
      CLICKHOUSE_PASSWORD: admin
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "localhost:8123/ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    tmpfs:
      - /var/lib/clickhouse

  signoz-otel-collector-test:
    image: signoz/signoz-otel-collector:0.88.11
    container_name: ppd_signoz_otel_collector_test
    command: ["--config=/etc/otel-collector-config.yaml"]
    ports:
      - "4319:4318"
    environment:
      - OTEL_RESOURCE_ATTRIBUTES=service.name=patient-price-discovery-provider
    depends_on:
      - clickhouse-test
    volumes:
      - ./signoz-otel-collector-config.yaml:/etc/otel-collector-config.yaml
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "localhost:13133"]
      interval: 5s
      timeout: 5s
      retries: 5

  provider-api-test:
    build:
      context: .
      dockerfile: Dockerfile.provider
    container_name: ppd_provider_api_test
    ports:
      - "3002:3000"
    environment:
      - NODE_ENV=development
      - PORT=3000
      - OTEL_ENABLED=true
      - OTEL_SERVICE_NAME=patient-price-discovery-provider
      - OTEL_SERVICE_VERSION=1.0.0
      - OTEL_ENDPOINT=http://signoz-otel-collector-test:4318
      - GOOGLE_CLIENT_EMAIL=
      - GOOGLE_PRIVATE_KEY=
      - GOOGLE_PROJECT_ID=
      - SPREADSHEET_IDS=
    depends_on:
      - signoz-otel-collector-test
