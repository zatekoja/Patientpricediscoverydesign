name: Main CI/CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force-deploy:
        description: 'Force deployment even on PR'
        type: boolean
        required: false
        default: false
      target-environment:
        description: 'Target environment for deployment'
        type: choice
        required: false
        default: 'dev'
        options:
          - dev
          - staging
          - prod

permissions:
  contents: read
  pull-requests: write
  security-events: write
  checks: write
  id-token: write
  actions: read

concurrency:
  group: main-pipeline-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.25.0'
  NODE_VERSION: '20'
  AWS_REGION: 'eu-west-1'

jobs:
  # ==========================================
  # Change Detection
  # ==========================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend-changed: ${{ steps.changes.outputs.backend }}
      typescript-provider-changed: ${{ steps.changes.outputs.typescript-provider }}
      frontend-changed: ${{ steps.changes.outputs.frontend }}
      infrastructure-changed: ${{ steps.changes.outputs.infrastructure }}
      should-deploy: ${{ steps.deploy-decision.outputs.should-deploy }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect file changes
        id: changes
        run: |
          echo "Detecting changes..."
          bash ./scripts/detect-main-pipeline-changes.sh

      - name: Decide on deployment
        id: deploy-decision
        run: |
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… Will deploy - push to main branch"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.force-deploy }}" = "true" ]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… Will deploy - forced via workflow dispatch"
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Will not deploy - PR or no force flag"
          fi

  # ==========================================
  # Backend CI
  # ==========================================
  backend-ci:
    name: Backend CI
    needs: [detect-changes]
    if: needs.detect-changes.outputs.backend-changed == 'true'
    uses: ./.github/workflows/go-backend-ci.yml
    with:
      enable-summary: false
    secrets: inherit

  # ==========================================
  # TypeScript Provider CI
  # ==========================================
  typescript-provider-ci:
    name: TypeScript Provider CI
    needs: [detect-changes]
    if: needs.detect-changes.outputs.typescript-provider-changed == 'true'
    uses: ./.github/workflows/typescript-frontend-ci.yml
    with:
      enable-summary: false
    secrets: inherit

  # ==========================================
  # Frontend CI
  # ==========================================
  frontend-ci:
    name: Frontend CI
    needs: [detect-changes]
    if: needs.detect-changes.outputs.frontend-changed == 'true'
    uses: ./.github/workflows/frontend-ci.yml
    with:
      enable-summary: false
    secrets: inherit

  # ==========================================
  # Infrastructure CI (Pulumi)
  # ==========================================
  infra-ci:
    name: Infrastructure CI
    needs: [detect-changes]
    if: needs.detect-changes.outputs.infrastructure-changed == 'true'
    uses: ./.github/workflows/infra-ci.yml
    with:
      enable-summary: false
    secrets: inherit

  # ==========================================
  # Deployment (only on main branch or forced)
  # ==========================================
  deploy:
    name: Deploy to AWS
    needs: [detect-changes, backend-ci, typescript-provider-ci, frontend-ci, infra-ci]
    if: always() && needs.detect-changes.outputs.should-deploy == 'true' && (needs.backend-ci.result == 'success' || needs.backend-ci.result == 'skipped') && (needs.typescript-provider-ci.result == 'success' || needs.typescript-provider-ci.result == 'skipped') && (needs.frontend-ci.result == 'success' || needs.frontend-ci.result == 'skipped') && (needs.infra-ci.result == 'success' || needs.infra-ci.result == 'skipped')
    uses: ./.github/workflows/cd-deploy.yml
    with:
      environment: ${{ inputs.target-environment || 'dev' }}
      deployment-type: 'auto'
      skip-approval: ${{ inputs.target-environment == 'dev' || inputs.target-environment == '' }}
    secrets: inherit

  # ==========================================
  # Pipeline Summary
  # ==========================================
  pipeline-summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, backend-ci, typescript-provider-ci, frontend-ci, infra-ci, deploy]
    if: always()

    steps:
      - name: Generate pipeline summary
        run: |
          echo "## ðŸš€ Patient Price Discovery Design - CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Event info
          echo "### Event Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Changes detected
          echo "### Changes Detected" >> $GITHUB_STEP_SUMMARY
          BACKEND_CHANGED="${{ needs.detect-changes.outputs.backend-changed }}"
          TS_PROVIDER_CHANGED="${{ needs.detect-changes.outputs.typescript-provider-changed }}"
          FRONTEND_CHANGED="${{ needs.detect-changes.outputs.frontend-changed }}"
          INFRA_CHANGED="${{ needs.detect-changes.outputs.infrastructure-changed }}"
          
          echo "- Backend (Go): $([ "$BACKEND_CHANGED" = "true" ] && echo "âœ… Changed" || echo "â­ï¸ No changes")" >> $GITHUB_STEP_SUMMARY
          echo "- TypeScript Provider: $([ "$TS_PROVIDER_CHANGED" = "true" ] && echo "âœ… Changed" || echo "â­ï¸ No changes")" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend (React): $([ "$FRONTEND_CHANGED" = "true" ] && echo "âœ… Changed" || echo "â­ï¸ No changes")" >> $GITHUB_STEP_SUMMARY
          echo "- Infrastructure: $([ "$INFRA_CHANGED" = "true" ] && echo "âœ… Changed" || echo "â­ï¸ No changes")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # CI Results
          echo "### CI Results" >> $GITHUB_STEP_SUMMARY
          BACKEND_CI="${{ needs.backend-ci.result }}"
          TS_PROVIDER_CI="${{ needs.typescript-provider-ci.result }}"
          FRONTEND_CI="${{ needs.frontend-ci.result }}"
          INFRA_CI="${{ needs.infra-ci.result }}"
          DEPLOY_RESULT="${{ needs.deploy.result }}"
          
          display_status() {
            case "$1" in
              "success") echo "âœ… **$2:** Passed" ;;
              "skipped") echo "â­ï¸ **$2:** Skipped" ;;
              "failure") echo "âŒ **$2:** Failed" ;;
              *) echo "âš ï¸ **$2:** Unknown" ;;
            esac
          }
          
          display_status "$BACKEND_CI" "Backend CI (Go)" >> $GITHUB_STEP_SUMMARY
          display_status "$TS_PROVIDER_CI" "TypeScript Provider CI" >> $GITHUB_STEP_SUMMARY
          display_status "$FRONTEND_CI" "Frontend CI (React)" >> $GITHUB_STEP_SUMMARY
          display_status "$INFRA_CI" "Infrastructure CI (Pulumi)" >> $GITHUB_STEP_SUMMARY
          display_status "$DEPLOY_RESULT" "Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Deployment info
          if [ "$DEPLOY_RESULT" = "success" ]; then
            TARGET_ENV="${{ inputs.target-environment || 'dev' }}"
            echo "### ðŸŒ Deployment URLs" >> $GITHUB_STEP_SUMMARY
            if [ "$TARGET_ENV" = "prod" ]; then
              echo "- **Frontend:** https://ateru.ng" >> $GITHUB_STEP_SUMMARY
              echo "- **API:** https://api.ateru.ng" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **Frontend:** https://$TARGET_ENV.ateru.ng" >> $GITHUB_STEP_SUMMARY
              echo "- **API:** https://api.$TARGET_ENV.ateru.ng" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Overall status
          if [[ "$BACKEND_CI" == "failure" ]] || [[ "$TS_PROVIDER_CI" == "failure" ]] || [[ "$FRONTEND_CI" == "failure" ]] || [[ "$INFRA_CI" == "failure" ]] || [[ "$DEPLOY_RESULT" == "failure" ]]; then
            echo "### âŒ PIPELINE: FAILED" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.detect-changes.outputs.should-deploy }}" = "true" ] && [ "$DEPLOY_RESULT" = "success" ]; then
            echo "### âœ… PIPELINE: SUCCESS (DEPLOYED)" >> $GITHUB_STEP_SUMMARY
          elif [[ "$BACKEND_CI" == "success" || "$BACKEND_CI" == "skipped" ]] && [[ "$TS_PROVIDER_CI" == "success" || "$TS_PROVIDER_CI" == "skipped" ]] && [[ "$FRONTEND_CI" == "success" || "$FRONTEND_CI" == "skipped" ]]; then
            echo "### âœ… PIPELINE: SUCCESS (CI ONLY)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ PIPELINE: PARTIAL SUCCESS" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**AWS Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Domain:** ateru.ng" >> $GITHUB_STEP_SUMMARY
