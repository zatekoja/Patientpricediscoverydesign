# SigNoz Observability Stack for P2PBets
# Usage: docker compose -f docker-compose.yml -f docker-compose.signoz.yml up -d
#
# Access Points:
#   - SigNoz UI: http://localhost:3301
#   - OTLP gRPC: localhost:4317
#   - OTLP HTTP: localhost:4318

x-logging: &default-logging
  driver: json-file
  options:
    max-size: "50m"
    max-file: "3"

services:
  # Zookeeper - Coordination service for ClickHouse
  signoz-zookeeper:
    image: zookeeper:latest
    container_name: signoz-zookeeper
    hostname: signoz-zookeeper
    environment:
      - ZOO_SERVER_ID=1
      - ALLOW_ANONYMOUS_LOGIN=yes
      - ZOO_AUTOPURGE_INTERVAL=1
      - ZOO_4LW_COMMANDS_WHITELIST=*
    volumes:
      - signoz-zookeeper-data:/data
    healthcheck:
      test: ["CMD", "bash", "-c", "echo ruok | nc localhost 2181 | grep imok"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    logging: *default-logging
    networks:
      - go-network

  # ClickHouse - Time-series database for telemetry storage
  signoz-clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: signoz-clickhouse
    hostname: signoz-clickhouse
    tty: true
    ports:
      - "9100:9000"   # Native protocol (remapped from 9000 to avoid conflict with graphql-handler)
      - "8123:8123"   # HTTP interface
    environment:
      - CLICKHOUSE_DB=signoz_traces
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=signoz
    volumes:
      - signoz-clickhouse-data:/var/lib/clickhouse
      - signoz-clickhouse-logs:/var/log/clickhouse-server
      - ./vendor/signoz/clickhouse-zookeeper.xml:/etc/clickhouse-server/config.d/zookeeper.xml:ro
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
      nproc:
        soft: 65535
        hard: 65535
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "localhost:8123/ping"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    logging: *default-logging
    depends_on:
      signoz-zookeeper:
        condition: service_healthy
    networks:
      - go-network

  # Schema Migrator - Initializes ClickHouse databases
  signoz-schema-migrator:
    image: signoz/signoz-schema-migrator:latest
    container_name: signoz-schema-migrator
    command:
      - "sync"
      - "--dsn=tcp://signoz-clickhouse:9000?username=default&password=signoz"
      - "--cluster-name=default"
    restart: on-failure
    logging: *default-logging
    depends_on:
      signoz-clickhouse:
        condition: service_healthy
      signoz-zookeeper:
        condition: service_healthy
    networks:
      - go-network

  # OpenTelemetry Collector - Receives traces, metrics, and logs
  signoz-otel-collector:
    image: signoz/signoz-otel-collector:latest
    container_name: signoz-otel-collector
    hostname: signoz-otel-collector
    command:
      - "--config=/etc/otel-collector-config.yaml"
    ports:
      - "4317:4317"   # OTLP gRPC receiver
      - "4318:4318"   # OTLP HTTP receiver
    volumes:
      - ./vendor/signoz/otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
    env_file:
      - .test.base.env
    environment:
      - OTEL_RESOURCE_ATTRIBUTES=host.name=signoz-otel-collector
      - LOW_CARDINAL_EXCEPTION_GROUPING=true
    healthcheck:
      test: ["CMD", "/bin/bash", "-c", "echo > /dev/tcp/localhost/13133"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    logging: *default-logging
    depends_on:
      signoz-clickhouse:
        condition: service_healthy
      signoz-schema-migrator:
        condition: service_completed_successfully
    networks:
      go-network:
        aliases:
          - signoz-otel-collector
          - otel-collector

  # SigNoz - Unified Frontend, Query Service, and Alertmanager
  signoz:
    image: signoz/signoz:latest
    container_name: signoz
    hostname: signoz
    ports:
      - "3301:8080" # UI
    command:
      - "--to=query-service"
      - "--storage=clickhouse"
    environment:
      - ClickHouseUrl=tcp://signoz-clickhouse:9000?username=default&password=signoz
      - CLICKHOUSE_URL=tcp://signoz-clickhouse:9000?username=default&password=signoz
      - SIGNOZ_CLICKHOUSE_URL=tcp://signoz-clickhouse:9000?username=default&password=signoz
      - SIGNOZ_TOKENIZER_JWT_SECRET=p2pbets_secret_key_for_local_dev
    restart: unless-stopped
    logging: *default-logging
    depends_on:
      signoz-clickhouse:
        condition: service_healthy
      signoz-otel-collector:
        condition: service_healthy
    volumes:
      - signoz-data:/var/lib/signoz
    networks:
      - go-network

volumes:
  signoz-zookeeper-data:
    driver: local
  signoz-clickhouse-data:
    driver: local
  signoz-clickhouse-logs:
    driver: local
  signoz-data:
    driver: local

networks:
  go-network:
    external: true
    name: backend_go-network
